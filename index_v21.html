
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sweat Tracker ‚Äî v2.1 Boxscore</title>
<style>
  :root{
    --bg:#0b1020; --card:#11162a; --ink:#f8fafc; --muted:#94a3b8; --line:#1f2a44;
    --accent:#7c3aed; --accent2:#06b6d4; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#0a0f20,#0b1020 40%,#0e1228);color:var(--ink);font-family:Inter,system-ui,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:28px;margin:0;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;background:rgba(255,255,255,.04);padding:6px;border-radius:12px;border:1px solid var(--line)}
  .tab{padding:10px 14px;border-radius:10px;cursor:pointer;color:var(--muted);border:1px solid transparent}
  .tab.active{background:linear-gradient(180deg,rgba(124,58,237,.2),rgba(6,182,212,.15));color:var(--ink);border-color:#2b375c}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .gameHdr{border-left:4px solid #4158D0;background:linear-gradient(90deg, rgba(65,88,208,.25), rgba(200,80,192,.12));padding:10px;border-radius:8px;margin:18px 0 10px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .leg{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:10px 0}
  .pill{background:#243052;border:1px solid #2b375c;border-radius:999px;padding:2px 10px;font-size:12px;color:#c3d3ff}
  .bar{height:12px;background:#1a2340;border:1px solid #2b375c;border-radius:8px;overflow:hidden;flex:1}
  .fill{height:100%;background:linear-gradient(90deg,#10b981,#38bdf8);width:0%}
  .pct{width:50px;text-align:right;font-variant-numeric:tabular-nums;color:#c7d2fe}
  .val{min-width:56px;text-align:right;font-variant-numeric:tabular-nums;color:#e2e8f0}
  .split{height:1px;background:var(--line);margin:8px 0}
  .slipbar{height:14px;background:#1a2340;border:1px solid #2b375c;border-radius:9px;overflow:hidden}
  .slipfill{height:100%;background:linear-gradient(90deg,#10b981,#38bdf8);width:0%}
  .tag{font-size:12px;background:#243052;border:1px solid #2b375c;padding:2px 8px;border-radius:999px;color:#e5e7eb}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:#0f152a;border:1px solid #202b4a;border-radius:14px;padding:12px}
  .team{display:flex;align-items:center;gap:8px}
  .badge{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.25)}
  .label{font-size:13px;color:#cbd5e1}
  .score{font-size:22px;font-weight:800;letter-spacing:.5px}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px;color:#cbd5e1}
  .statusLive{color:#22c55e}
  .statusFinal{color:#c3d3ff}
  .statusSched{color:#94a3b8}
  .dot{width:8px;height:8px;border-radius:50%;background:#22c55e;box-shadow:0 0 12px #22c55e}
  .hide{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üèà Sweat Tracker</h1>
    <div class="tabs">
      <div class="tab active" data-tab="bets">Bet Slips</div>
      <div class="tab" data-tab="scores">Live Scores</div>
    </div>
  </header>

  <div class="panel"><strong>Feed mode:</strong> v2.1 <code>games/{id}/boxscore.json</code>. If scores still show 0, your plan may not include Boxscore; this page will fall back to <code>team_gamelogs</code> for scores only.</div>

  <!-- Bets (same DOM as prior) -->
  <div class="gameHdr"><strong>Green Bay Packers @ Dallas Cowboys</strong></div>
  <div class="panel slip" id="slip-gb-a">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Bet Slip A</h3><span class="tag" id="slip-gb-a-count">0 / 0</span></div>
    <div class="split"></div>
    <div class="leg" data-leg-id="dak175"><div class="row"><span class="pill">Pass Yds</span><strong>Dak Prescott</strong> ‚Äî 175+</div><div class="row"><span class="val" data-target="175">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="love200"><div class="row"><span class="pill">Pass Yds</span><strong>Jordan Love</strong> ‚Äî 200+</div><div class="row"><span class="val" data-target="200">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="ferg5"><div class="row"><span class="pill">Recs</span><strong>Jake Ferguson</strong> ‚Äî 5+</div><div class="row"><span class="val" data-target="5">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="dak1td"><div class="row"><span class="pill">Pass TD</span><strong>Dak Prescott</strong> ‚Äî 1+</div><div class="row"><span class="val" data-target="1">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="love1p5td"><div class="row"><span class="pill">Pass TD</span><strong>Jordan Love</strong> ‚Äî Over 1.5</div><div class="row"><span class="val" data-target="2">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="split"></div>
    <div class="slipbar"><div class="slipfill" id="slip-gb-a-fill"></div></div>
  </div>

  <div class="gameHdr"><strong>Baltimore Ravens @ Kansas City Chiefs</strong></div>
  <div class="panel slip" id="slip-kc-c">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Bet Slip C ‚Äî Ravens Focus</h3><span class="tag" id="slip-kc-c-count">0 / 0</span></div>
    <div class="split"></div>
    <div class="leg" data-leg-id="zay50"><div class="row"><span class="pill">Rec Yds</span><strong>Zay Flowers</strong> ‚Äî 50+</div><div class="row"><span class="val" data-target="50">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="zay5rec"><div class="row"><span class="pill">Recs</span><strong>Zay Flowers</strong> ‚Äî 5+</div><div class="row"><span class="val" data-target="5">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="henry60"><div class="row"><span class="pill">Rush Yds</span><strong>Derrick Henry</strong> ‚Äî 60+</div><div class="row"><span class="val" data-target="60">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar30rush"><div class="row"><span class="pill">Rush Yds</span><strong>Lamar Jackson</strong> ‚Äî 30+</div><div class="row"><span class="val" data-target="30">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar175pass"><div class="row"><span class="pill">Pass Yds</span><strong>Lamar Jackson</strong> ‚Äî 175+</div><div class="row"><span class="val" data-target="175">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="split"></div>
    <div class="slipbar"><div class="slipfill" id="slip-kc-c-fill"></div></div>
  </div>

  <div class="panel slip" id="slip-kc-d">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Bet Slip D ‚Äî Both QBs + Kelce/Zay</h3><span class="tag" id="slip-kc-d-count">0 / 0</span></div>
    <div class="split"></div>
    <div class="leg" data-leg-id="mah200"><div class="row"><span class="pill">Pass Yds</span><strong>Patrick Mahomes</strong> ‚Äî 200+</div><div class="row"><span class="val" data-target="200">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar175pass_d"><div class="row"><span class="pill">Pass Yds</span><strong>Lamar Jackson</strong> ‚Äî 175+</div><div class="row"><span class="val" data-target="175">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="zay30"><div class="row"><span class="pill">Rec Yds</span><strong>Zay Flowers</strong> ‚Äî 30+</div><div class="row"><span class="val" data-target="30">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="kelce20"><div class="row"><span class="pill">Rec Yds</span><strong>Travis Kelce</strong> ‚Äî 20+</div><div class="row"><span class="val" data-target="20">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="mah1td"><div class="row"><span class="pill">Pass TD</span><strong>Patrick Mahomes</strong> ‚Äî 1+</div><div class="row"><span class="val" data-target="1">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar1td"><div class="row"><span class="pill">Pass TD</span><strong>Lamar Jackson</strong> ‚Äî 1+</div><div class="row"><span class="val" data-target="1">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="split"></div>
    <div class="slipbar"><div class="slipfill" id="slip-kc-d-fill"></div></div>
  </div>

  <!-- Scores -->
  <section id="tab-scores" class="hide">
    <div class="panel">
      <div class="row" style="justify-content:space-between; width:100%">
        <div>
          <strong>Sunday Scoreboard ‚Äî Sept 28</strong>
          <div class="muted">Auto-refresh every 20s.</div>
        </div>
        <div class="row"><div class="dot"></div><span class="muted">Live</span></div>
      </div>
    </div>
    <div class="grid" id="scoreGrid"></div>
  </section>

</div>

<script>
const GAME_ID = { KC:"148800", GB:"148802" };
const WEEK_GAMES_PATH = 'v2.1/pull/nfl/2025-regular/week/4/games.json';
const DATE = '20250928'; // yyyymmdd for v2.1 date feeds

// utils
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
async function msf(path, q=''){
  const url = `/api/msf?path=${encodeURIComponent(path)}${q ? `&q=${encodeURIComponent(q)}` : ''}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('MSF '+r.status);
  return r.json();
}

// bets
const LEGS = {
  'dak175':   { game:'GB', name:'Dak Prescott',    target:175, path:['passing','passYards'] },
  'love200':  { game:'GB', name:'Jordan Love',     target:200, path:['passing','passYards'] },
  'ferg5':    { game:'GB', name:'Jake Ferguson',   target:5,   path:['receiving','receptions'] },
  'dak1td':   { game:'GB', name:'Dak Prescott',    target:1,   path:['passing','passTD'] },
  'love1p5td':{ game:'GB', name:'Jordan Love',     target:2,   path:['passing','passTD'] },
  'zay50':       { game:'KC', name:'Zay Flowers',   target:50,  path:['receiving','recYards'] },
  'zay5rec':     { game:'KC', name:'Zay Flowers',   target:5,   path:['receiving','receptions'] },
  'henry60':     { game:'KC', name:'Derrick Henry', target:60,  path:['rushing','rushYards'] },
  'lamar30rush': { game:'KC', name:'Lamar Jackson', target:30,  path:['rushing','rushYards'] },
  'lamar175pass':{ game:'KC', name:'Lamar Jackson', target:175, path:['passing','passYards'] },
  'mah200':      { game:'KC', name:'Patrick Mahomes', target:200, path:['passing','passYards'] },
  'lamar175pass_d':{ game:'KC', name:'Lamar Jackson', target:175, path:['passing','passYards'] },
  'zay30':       { game:'KC', name:'Zay Flowers',     target:30,  path:['receiving','recYards'] },
  'kelce20':     { game:'KC', name:'Travis Kelce',    target:20,  path:['receiving','recYards'] },
  'mah1td':      { game:'KC', name:'Patrick Mahomes', target:1,   path:['passing','passTD'] },
  'lamar1td':    { game:'KC', name:'Lamar Jackson',   target:1,   path:['passing','passTD'] },
};
const SLIPS = {
  'slip-gb-a':    ['dak175','love200','ferg5','dak1td','love1p5td'],
  'slip-kc-c':    ['zay50','zay5rec','henry60','lamar30rush','lamar175pass'],
  'slip-kc-d':    ['mah200','lamar175pass_d','zay30','kelce20','mah1td','lamar1td'],
};
function setValForLeg(legId, value){
  const leg = qs(`.leg[data-leg-id="${legId}"]`);
  if(!leg) return;
  const valEl = leg.querySelector('.val');
  const fill = leg.querySelector('.fill');
  const pct  = leg.querySelector('.pct');
  const target = Number(valEl.dataset.target);
  const now = Number(value||0);
  valEl.textContent = String(now);
  const p = Math.max(0, Math.min(100, Math.round((now/target)*100)));
  fill.style.width = p+'%';
  fill.style.background = (now>=target) ? 'linear-gradient(90deg,#10b981,#38bdf8)' : 'linear-gradient(90deg,#ef4444,#f59e0b)';
  pct.textContent = p+'%';
}
function calcSlipProgress(slipId){
  const legs = SLIPS[slipId] || [];
  let hit = 0;
  legs.forEach(l => {
    const cfg = LEGS[l];
    const legEl = qs(`.leg[data-leg-id="${l}"] .val`);
    if(!cfg || !legEl) return;
    const now = Number(legEl.textContent||0);
    if(now >= cfg.target) hit++;
  });
  return {hit,total:legs.length,pct: Math.round(100*hit/legs.length)};
}
function renderSlipProgress(slipId){
  const {hit,total,pct} = calcSlipProgress(slipId);
  const tag = qs(`#${slipId}-count`);
  const fill = qs(`#${slipId}-fill`);
  if(tag) tag.textContent = `${hit} / ${total}`;
  if(fill) fill.style.width = `${pct}%`;
}
function nameFromPlayer(p){ return p?.player?.name || [p?.player?.firstName, p?.player?.lastName].filter(Boolean).join(' '); }
function statsObject(p){ return p?.stats || p?.playerStats || {}; }
function getStat(stats, path){
  const [group, key] = path;
  const g = stats[group] || {};
  const candidates = {
    passYards:['passYards','passingYards','yards'],
    passTD:['passTD','passTDs','passingTD','passingTDs','td'],
    recYards:['recYards','receivingYards','yards'],
    receptions:['receptions','catches','rec'],
    rushYards:['rushYards','rushingYards','yards'],
  };
  const pickKey = candidates[key] || [key];
  for(const k of pickKey){ if(g[k] !== undefined) return Number(g[k])||0; }
  return 0;
}
async function getGameBox(id){
  // v2.1 per-game path
  return msf(`v2.1/pull/nfl/2025-regular/games/${encodeURIComponent(id)}/boxscore.json`);
}
async function refreshBets(){
  try{
    const [kc, gb] = await Promise.all([getGameBox(GAME_ID.KC), getGameBox(GAME_ID.GB)]);
    const liveKC = {}, liveGB = {};
    const pack = (box, map) => {
      const teams = box?.boxscore?.teams || box?.teams || [];
      teams.forEach(team => (team.players||team.playerStats||[]).forEach(p => {
        const name = nameFromPlayer(p); if(!name) return; map[name] = statsObject(p);
      }));
    };
    pack(kc, liveKC); pack(gb, liveGB);
    for(const [id,cfg] of Object.entries(LEGS)){
      const src = (cfg.game==='KC') ? liveKC : liveGB;
      const stats = src[cfg.name] || {};
      setValForLeg(id, getStat(stats, cfg.path));
    }
    Object.keys(SLIPS).forEach(renderSlipProgress);
  }catch(e){ console.warn('Bets refresh error', e); }
}

// scores (boxscore; if fails, fallback to team_gamelogs per date)
const TEAM = { ARI:'#97233F', ATL:'#A71930', BAL:'#241773', BUF:'#00338D', CAR:'#0085CA', CHI:'#0B162A',
  CIN:'#FB4F14', CLE:'#311D00', DAL:'#041E42', DEN:'#FB4F14', DET:'#0076B6', GB:'#203731', HOU:'#03202F',
  IND:'#002C5F', JAX:'#006778', KC:'#E31837', LAC:'#0080C6', LAR:'#003594', LV:'#000000', MIA:'#008E97',
  MIN:'#4F2683', NE:'#002244', NO:'#D3BC8D', NYG:'#0B2265', NYJ:'#125740', PHI:'#004C54', PIT:'#FFB612',
  SF:'#AA0000', SEA:'#002244', TB:'#D50A0A', TEN:'#0C2340', WAS:'#5A1414' };
function badge(abbr){ const c = TEAM[abbr] || '#4b5563'; return `<div class="badge" style="background:${c}">${abbr}</div>`; }
function safeAbbr(teamObj){ return teamObj?.abbreviation || teamObj?.abbr || teamObj?.code || '---'; }
function gameCard(g){
  const away = safeAbbr(g.awayTeam || g.away || g.visitor || {});
  const home = safeAbbr(g.homeTeam || g.home || {});
  const id = g.schedule?.id || g.game?.id || g.id;
  const aName = (g.awayTeam?.city? (g.awayTeam.city+' ') : '') + (g.awayTeam?.name || away);
  const hName = (g.homeTeam?.city? (g.homeTeam.city+' ') : '') + (g.homeTeam?.name || home);
  return `
  <div class="card" data-game="${id}">
    <div class="row" style="justify-content:space-between">
      <div class="row"><div class="team">${badge(away)} <div><div class="label">${aName}</div><div class="score" data-away>0</div></div></div></div>
      <div class="row"><div class="team">${badge(home)} <div><div class="label">${hName}</div><div class="score" data-home>0</div></div></div></div>
    </div>
    <div class="meta"><span class="label" data-status>Scheduled</span><span class="label" data-clock>‚Äî</span></div>
  </div>`;
}
async function loadSundayList(){
  const week = await msf(WEEK_GAMES_PATH);
  const arr = week?.games || [];
  const games = arr.filter(x=> (x.schedule?.startTime||'').slice(0,10)==='2025-09-28');
  qs('#scoreGrid').innerHTML = games.map(gameCard).join('');
  return games.map(g=> g.schedule?.id).filter(Boolean);
}
async function refreshScores(ids){
  try{
    await Promise.all(ids.map(async (id)=>{
      try{
        const box = await getGameBox(id);
        const awayScore = box?.score?.awayScoreTotal || box?.boxscore?.awayScore || 0;
        const homeScore = box?.score?.homeScoreTotal || box?.boxscore?.homeScore || 0;
        const status = box?.game?.status || box?.boxscore?.status || 'Scheduled';
        const clock  = box?.game?.clock  || box?.boxscore?.quarter || '';
        const card = qs(`.card[data-game="${id}"]`);
        if(!card) return;
        card.querySelector('[data-away]').textContent = awayScore;
        card.querySelector('[data-home]').textContent = homeScore;
        const sEl = card.querySelector('[data-status]'); const cEl = card.querySelector('[data-clock]');
        sEl.textContent=status; cEl.textContent=clock;
        sEl.classList.remove('statusLive','statusFinal','statusSched');
        if(/Final/i.test(status)) sEl.classList.add('statusFinal');
        else if(/In Progress|Live|Q\d|Half|OT/i.test(status)) sEl.classList.add('statusLive');
        else sEl.classList.add('statusSched');
      }catch(e){
        // Fallback: team gamelogs (scores only)
        const tg = await msf(`v2.1/pull/nfl/2025-regular/date/${DATE}/team_gamelogs.json`, 'game='+id);
        const logs = tg?.teamGamelogs || [];
        const bySide = {}; logs.forEach(l=>{
          const team = l?.team?.abbreviation; const pts = Number(l?.stats?.miscellaneous?.points||0);
          bySide[team] = pts;
        });
        // Can't map to sides reliably without team lookup; show totals if present
        const card = qs(`.card[data-game="${id}"]`);
        if(card){
          const vals = Object.values(bySide);
          if(vals.length>=2){
            // just show first two
            card.querySelector('[data-away]').textContent = vals[0];
            card.querySelector('[data-home]').textContent = vals[1];
          }
        }
      }
    }));
  }catch(e){ console.warn('Scores refresh error', e); }
}

// tabs
qsa('.tab').forEach(t=>t.onclick=()=>{
  qsa('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  document.querySelector('#tab-scores').classList.toggle('hide', tab!=='scores');
});

(async function init(){
  // build scores grid
  const ids = await loadSundayList();
  const tick = async ()=>{ refreshBets(); refreshScores(ids); };
  tick(); setInterval(tick, 20000);
})();
</script>
</body>
</html>
