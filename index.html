
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sweat Tracker — Fixed Scores Fallback</title>
<style>
  :root{
    --bg:#0b1020; --card:#11162a; --ink:#f8fafc; --muted:#94a3b8; --line:#1f2a44;
    --good:#10b981; --bad:#ef4444;
  }
  html,body{margin:0;padding:0;background:#0b1020;color:var(--ink);font-family:Inter,system-ui,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .panel{background:#11162a;border:1px solid #1f2a44;border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:#0f152a;border:1px solid #202b4a;border-radius:14px;padding:12px}
  .badge{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  .label{font-size:13px;color:#cbd5e1}
  .score{font-size:22px;font-weight:800}
  .ok{color:var(--good)} .err{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <strong>Status:</strong>
    <div id="status"></div>
    <div class="label">This build uses: v2.0 week list ➜ boxscore (v2.1 per-game). If boxscore blocked, falls back to <code>team_gamelogs</code> with the required <code>game=YYYYMMDD-AWY-HME</code>.</div>
  </div>

  <div class="panel"><strong>Sunday Scoreboard — Sept 28</strong></div>
  <div class="grid" id="scoreGrid"></div>
</div>

<script>
const WEEK_PATH_V20 = 'v2.0/pull/nfl/2025-regular/week/4/games.json';
const BOX_V21 = id => `v2.1/pull/nfl/2025-regular/games/${id}/boxscore.json`;
const TGLOGS_V21 = (date, gameKey) => `v2.1/pull/nfl/2025-regular/date/${date}/team_gamelogs.json`;

const TEAM = { ARI:'#97233F', ATL:'#A71930', BAL:'#241773', BUF:'#00338D', CAR:'#0085CA', CHI:'#0B162A',
  CIN:'#FB4F14', CLE:'#311D00', DAL:'#041E42', DEN:'#FB4F14', DET:'#0076B6', GB:'#203731', HOU:'#03202F',
  IND:'#002C5F', JAX:'#006778', KC:'#E31837', LAC:'#0080C6', LAR:'#003594', LV:'#000000', MIA:'#008E97',
  MIN:'#4F2683', NE:'#002244', NO:'#D3BC8D', NYG:'#0B2265', NYJ:'#125740', PHI:'#004C54', PIT:'#FFB612',
  SF:'#AA0000', SEA:'#002244', TB:'#D50A0A', TEN:'#0C2340', WAS:'#5A1414' };

const qs = s => document.querySelector(s);
async function msf(path, q=''){
  const url = `/api/msf?path=${encodeURIComponent(path)}${q ? `&q=${encodeURIComponent(q)}` : ''}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
const badge = abbr => `<div class="badge" style="background:${TEAM[abbr]||'#64748b'}">${abbr}</div>`;
const card = (id, awayAbbr, homeAbbr, awayName, homeName) => `
  <div class="card" data-id="${id}">
    <div class="row" style="justify-content:space-between">
      <div class="row"><div>${badge(awayAbbr)}</div><div><div class="label">${awayName}</div><div class="score" data-away>0</div></div></div>
      <div class="row"><div>${badge(homeAbbr)}</div><div><div class="label">${homeName}</div><div class="score" data-home>0</div></div></div>
    </div>
    <div class="label" data-status>Scheduled</div>
  </div>`;

(async function init(){
  const status = qs('#status');
  try{
    const week = await msf(WEEK_PATH_V20);
    const games = (week.games||[]).filter(g => (g.schedule?.startTime||'').slice(0,10)==='2025-09-28');

    // Build map: id -> gameKey YYYYMMDD-AWY-HME
    const map = {};
    const grid = qs('#scoreGrid');
    grid.innerHTML = games.map(g=>{
      const id = g.schedule.id;
      const s = g.schedule.startTime.slice(0,10).replaceAll('-',''); // YYYYMMDD
      const away = g.awayTeam.abbreviation;
      const home = g.homeTeam.abbreviation;
      map[id] = `${s}-${away}-${home}`;
      return card(id, away, home, (g.awayTeam.city+' '+g.awayTeam.name), (g.homeTeam.city+' '+g.homeTeam.name));
    }).join('');

    // Poll updates
    async function update(){
      await Promise.all(games.map(async g=>{
        const id = g.schedule.id;
        const gameKey = map[id];
        const cardEl = document.querySelector(`.card[data-id="${id}"]`);
        if(!cardEl) return;
        try{
          const box = await msf(BOX_V21(id));
          const a = box?.score?.awayScoreTotal || box?.boxscore?.awayScore || 0;
          const h = box?.score?.homeScoreTotal || box?.boxscore?.homeScore || 0;
          cardEl.querySelector('[data-away]').textContent=a;
          cardEl.querySelector('[data-home]').textContent=h;
          cardEl.querySelector('[data-status]').textContent = box?.game?.status || box?.boxscore?.status || '—';
        }catch(e){
          // Fallback: team_gamelogs with required gameKey
          try{
            const t = await msf(TGLOGS_V21(gameKey.slice(0,8)), 'game='+gameKey);
            const logs = t?.teamGamelogs || t?.gamelogs || [];
            // Assign by matching team abbr to cards
            logs.forEach(l => {
              const ab = l?.team?.abbreviation;
              const pts = Number(l?.stats?.miscellaneous?.points || l?.stats?.scoring?.points || 0);
              if(ab === g.awayTeam.abbreviation) cardEl.querySelector('[data-away]').textContent=pts;
              if(ab === g.homeTeam.abbreviation) cardEl.querySelector('[data-home]').textContent=pts;
            });
            cardEl.querySelector('[data-status]').textContent = '—';
          }catch(e2){
            // leave zeros
          }
        }
      }));
    }
    update();
    setInterval(update, 20000);
    status.innerHTML = '<span class="ok">Connected ✓</span>';
  }catch(e){
    status.innerHTML = '<span class="err">Failed to load week list: '+e.message+'</span>';
  }
})();
</script>
</body>
</html>
