
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sweat Tracker — Robust Scores</title>
<style>
  :root{--bg:#0b1020;--card:#11162a;--ink:#f8fafc;--muted:#94a3b8;--line:#1f2a44;--good:#10b981;--bad:#ef4444}
  body{margin:0;background:#0b1020;color:var(--ink);font-family:Inter,system-ui,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .panel{background:#11162a;border:1px solid #1f2a44;border-radius:14px;padding:14px;margin:12px 0}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:#0f152a;border:1px solid #202b4a;border-radius:14px;padding:12px}
  .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .badge{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  .label{font-size:13px;color:#cbd5e1}
  .score{font-size:22px;font-weight:800}
  .ok{color:var(--good)} .err{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel"><strong>Status:</strong> <span id="status">loading…</span></div>
  <div class="panel"><strong>Sunday Scoreboard — Sept 28</strong></div>
  <div class="grid" id="grid"></div>
</div>
<script>
const TEAM = { ARI:'#97233F', ATL:'#A71930', BAL:'#241773', BUF:'#00338D', CAR:'#0085CA', CHI:'#0B162A',
 CIN:'#FB4F14', CLE:'#311D00', DAL:'#041E42', DEN:'#FB4F14', DET:'#0076B6', GB:'#203731', HOU:'#03202F',
 IND:'#002C5F', JAX:'#006778', KC:'#E31837', LAC:'#0080C6', LAR:'#003594', LV:'#000000', MIA:'#008E97',
 MIN:'#4F2683', NE:'#002244', NO:'#D3BC8D', NYG:'#0B2265', NYJ:'#125740', PHI:'#004C54', PIT:'#FFB612',
 SF:'#AA0000', SEA:'#002244', TB:'#D50A0A', TEN:'#0C2340', WAS:'#5A1414' };
const badge = a=>`<div class="badge" style="background:${TEAM[a]||'#64748b'}">${a||'---'}</div>`;
const qs = s=>document.querySelector(s);
async function msf(path,q=''){
  const url = `/api/msf?path=${encodeURIComponent(path)}${q?`&q=${encodeURIComponent(q)}`:''}`;
  const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}
function safeAbbr(t){ return (t&& (t.abbreviation||t.abbr||t.code||t.teamAbbreviation))||'---'; }
function fmtName(t){ if(!t) return '—'; const city=t.city||''; const name=t.name||t.teamName||safeAbbr(t); return (city?city+' ':'')+name; }
function card(id,awayAbbr,homeAbbr,awayName,homeName){
  return `<div class="card" data-id="${id}">
    <div class="row">
      <div class="row" style="gap:8px"><div>${badge(awayAbbr)}</div><div><div class="label">${awayName}</div><div class="score" data-away>0</div></div></div>
      <div class="row" style="gap:8px"><div>${badge(homeAbbr)}</div><div><div class="label">${homeName}</div><div class="score" data-home>0</div></div></div>
    </div>
    <div class="label" data-status>Scheduled</div>
  </div>`;
}
async function getWeek(){
  try{ return await msf('v2.0/pull/nfl/2025-regular/week/4/games.json'); }
  catch(e){ return await msf('v2.1/pull/nfl/2025-regular/week/4/games.json'); }
}
const BOX_V21 = id => `v2.1/pull/nfl/2025-regular/games/${id}/boxscore.json`;
async function init(){
  const status=qs('#status'); const grid=qs('#grid');
  try{
    const wk = await getWeek();
    const list = (wk.games||wk.game||[]).filter(g=> (g.schedule?.startTime||'').slice(0,10)==='2025-09-28');
    if(!list.length) throw new Error('No games for that date from week feed.');
    // build cards and gameKeys
    const games = list.map(g=>{
      const sch=g.schedule||{}; const away=g.awayTeam||g.away||{}; const home=g.homeTeam||g.home||{};
      if(!away || !home) return null;
      const id=sch.id; const date=(sch.startTime||'').slice(0,10).replaceAll('-','');
      const awayAbbr=safeAbbr(away); const homeAbbr=safeAbbr(home);
      const key = `${date}-${awayAbbr}-${homeAbbr}`;
      return {id,key,awayAbbr,homeAbbr,awayName:fmtName(away),homeName:fmtName(home)};
    }).filter(Boolean);
    grid.innerHTML = games.map(g=>card(g.id,g.awayAbbr,g.homeAbbr,g.awayName,g.homeName)).join('');
    status.innerHTML = '<span class="ok">Connected ✓</span>';
    async function update(){
      await Promise.all(games.map(async g=>{
        const el=document.querySelector(`.card[data-id="${g.id}"]`);
        if(!el) return;
        try{
          const box = await msf(BOX_V21(g.id));
          const a=box?.score?.awayScoreTotal||box?.boxscore?.awayScore||0;
          const h=box?.score?.homeScoreTotal||box?.boxscore?.homeScore||0;
          el.querySelector('[data-away]').textContent=a;
          el.querySelector('[data-home]').textContent=h;
          el.querySelector('[data-status]').textContent = box?.game?.status || box?.boxscore?.status || '—';
        }catch(e){
          // fallback: team gamelogs per game key
          try{
            const tg = await msf(`v2.1/pull/nfl/2025-regular/date/${g.key.slice(0,8)}/team_gamelogs.json`, 'game='+g.key);
            const logs=tg?.teamGamelogs||tg?.gamelogs||[];
            logs.forEach(l=>{
              const ab=l?.team?.abbreviation;
              const pts = Number(l?.stats?.miscellaneous?.points || l?.stats?.scoring?.points || 0);
              if(ab===g.awayAbbr) el.querySelector('[data-away]').textContent=pts;
              if(ab===g.homeAbbr) el.querySelector('[data-home]').textContent=pts;
            });
            el.querySelector('[data-status]').textContent='—';
          }catch(e2){ /* leave zeros */ }
        }
      }));
    }
    update(); setInterval(update, 20000);
  }catch(err){
    status.innerHTML = '<span class="err">'+err.message+'</span>';
  }
}
init();
</script>
</body>
</html>
