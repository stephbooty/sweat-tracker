
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sweat Tracker ‚Äî Gamelogs Mode (No Boxscore)</title>
<style>
  :root{
    --bg:#0b1020; --card:#11162a; --ink:#f8fafc; --muted:#94a3b8; --line:#1f2a44;
    --accent:#7c3aed; --accent2:#06b6d4; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  html,body{margin:0;padding:0;background:#0b1020;color:var(--ink);font-family:Inter,system-ui,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:28px;margin:0;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;background:rgba(255,255,255,.04);padding:6px;border-radius:12px;border:1px solid var(--line)}
  .tab{padding:10px 14px;border-radius:10px;cursor:pointer;color:var(--muted);border:1px solid transparent}
  .tab.active{background:linear-gradient(180deg,rgba(124,58,237,.2),rgba(6,182,212,.15));color:var(--ink);border-color:#2b375c}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .gameHdr{border-left:4px solid #4158D0;background:linear-gradient(90deg, rgba(65,88,208,.25), rgba(200,80,192,.12));padding:10px;border-radius:8px;margin:18px 0 10px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .leg{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:10px 0}
  .pill{background:#243052;border:1px solid #2b375c;border-radius:999px;padding:2px 10px;font-size:12px;color:#c3d3ff}
  .bar{height:12px;background:#1a2340;border:1px solid #2b375c;border-radius:8px;overflow:hidden;flex:1}
  .fill{height:100%;background:linear-gradient(90deg,#10b981,#38bdf8);width:0%}
  .pct{width:50px;text-align:right;font-variant-numeric:tabular-nums;color:#c7d2fe}
  .val{min-width:56px;text-align:right;font-variant-numeric:tabular-nums;color:#e2e8f0}
  .split{height:1px;background:var(--line);margin:8px 0}
  .slipbar{height:14px;background:#1a2340;border:1px solid #2b375c;border-radius:9px;overflow:hidden}
  .slipfill{height:100%;background:linear-gradient(90deg,#10b981,#38bdf8);width:0%}
  .tag{font-size:12px;background:#243052;border:1px solid #2b375c;padding:2px 8px;border-radius:999px;color:#e5e7eb}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:#0f152a;border:1px solid #202b4a;border-radius:14px;padding:12px}
  .team{display:flex;align-items:center;gap:8px}
  .badge{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.25)}
  .label{font-size:13px;color:#cbd5e1}
  .score{font-size:22px;font-weight:800;letter-spacing:.5px}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px;color:#cbd5e1}
  .statusLive{color:#22c55e}
  .statusFinal{color:#c3d3ff}
  .statusSched{color:#94a3b8}
  .dot{width:8px;height:8px;border-radius:50%;background:#22c55e;box-shadow:0 0 12px #22c55e}
  .hide{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üèà Sweat Tracker</h1>
    <div class="tabs">
      <div class="tab active" data-tab="bets">Bet Slips</div>
      <div class="tab" data-tab="scores">Live Scores</div>
    </div>
  </header>

  <div class="panel">
    <strong>Mode:</strong> using <code>v2.1 player_gamelogs</code> for legs and <code>v2.1 team_gamelogs</code> for scores. No boxscore needed.
    <div class="muted">If totals stay 0 before kickoff, that's expected. Updates every 20s.</div>
  </div>

  <!-- Bets -->
  <div class="gameHdr"><strong>Green Bay Packers @ Dallas Cowboys</strong></div>
  <div class="panel slip" id="slip-gb-a">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Bet Slip A</h3><span class="tag" id="slip-gb-a-count">0 / 0</span></div>
    <div class="split"></div>
    <div class="leg" data-leg-id="dak175"><div class="row"><span class="pill">Pass Yds</span><strong>Dak Prescott</strong> ‚Äî 175+</div><div class="row"><span class="val" data-target="175">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="love200"><div class="row"><span class="pill">Pass Yds</span><strong>Jordan Love</strong> ‚Äî 200+</div><div class="row"><span class="val" data-target="200">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="ferg5"><div class="row"><span class="pill">Recs</span><strong>Jake Ferguson</strong> ‚Äî 5+</div><div class="row"><span class="val" data-target="5">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="dak1td"><div class="row"><span class="pill">Pass TD</span><strong>Dak Prescott</strong> ‚Äî 1+</div><div class="row"><span class="val" data-target="1">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="love1p5td"><div class="row"><span class="pill">Pass TD</span><strong>Jordan Love</strong> ‚Äî Over 1.5</div><div class="row"><span class="val" data-target="2">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="split"></div>
    <div class="slipbar"><div class="slipfill" id="slip-gb-a-fill"></div></div>
  </div>

  <div class="gameHdr"><strong>Baltimore Ravens @ Kansas City Chiefs</strong></div>
  <div class="panel slip" id="slip-kc-c">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Bet Slip C ‚Äî Ravens Focus</h3><span class="tag" id="slip-kc-c-count">0 / 0</span></div>
    <div class="split"></div>
    <div class="leg" data-leg-id="zay50"><div class="row"><span class="pill">Rec Yds</span><strong>Zay Flowers</strong> ‚Äî 50+</div><div class="row"><span class="val" data-target="50">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="zay5rec"><div class="row"><span class="pill">Recs</span><strong>Zay Flowers</strong> ‚Äî 5+</div><div class="row"><span class="val" data-target="5">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="henry60"><div class="row"><span class="pill">Rush Yds</span><strong>Derrick Henry</strong> ‚Äî 60+</div><div class="row"><span class="val" data-target="60">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar30rush"><div class="row"><span class="pill">Rush Yds</span><strong>Lamar Jackson</strong> ‚Äî 30+</div><div class="row"><span class="val" data-target="30">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar175pass"><div class="row"><span class="pill">Pass Yds</span><strong>Lamar Jackson</strong> ‚Äî 175+</div><div class="row"><span class="val" data-target="175">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="split"></div>
    <div class="slipbar"><div class="slipfill" id="slip-kc-c-fill"></div></div>
  </div>

  <div class="panel slip" id="slip-kc-d">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Bet Slip D ‚Äî Both QBs + Kelce/Zay</h3><span class="tag" id="slip-kc-d-count">0 / 0</span></div>
    <div class="split"></div>
    <div class="leg" data-leg-id="mah200"><div class="row"><span class="pill">Pass Yds</span><strong>Patrick Mahomes</strong> ‚Äî 200+</div><div class="row"><span class="val" data-target="200">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar175pass_d"><div class="row"><span class="pill">Pass Yds</span><strong>Lamar Jackson</strong> ‚Äî 175+</div><div class="row"><span class="val" data-target="175">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="zay30"><div class="row"><span class="pill">Rec Yds</span><strong>Zay Flowers</strong> ‚Äî 30+</div><div class="row"><span class="val" data-target="30">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="kelce20"><div class="row"><span class="pill">Rec Yds</span><strong>Travis Kelce</strong> ‚Äî 20+</div><div class="row"><span class="val" data-target="20">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="mah1td"><div class="row"><span class="pill">Pass TD</span><strong>Patrick Mahomes</strong> ‚Äî 1+</div><div class="row"><span class="val" data-target="1">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="leg" data-leg-id="lamar1td"><div class="row"><span class="pill">Pass TD</span><strong>Lamar Jackson</strong> ‚Äî 1+</div><div class="row"><span class="val" data-target="1">0</span><div class="bar"><div class="fill"></div></div><div class="pct">0%</div></div></div>
    <div class="split"></div>
    <div class="slipbar"><div class="slipfill" id="slip-kc-d-fill"></div></div>
  </div>

  <!-- Scores -->
  <section id="tab-scores" class="hide">
    <div class="panel">
      <div class="row" style="justify-content:space-between; width:100%">
        <div>
          <strong>Sunday Scoreboard ‚Äî Sept 28</strong>
          <div class="muted">Using team_gamelogs; updates every 20s.</div>
        </div>
        <div class="row"><div class="dot"></div><span class="muted">Live</span></div>
      </div>
    </div>
    <div class="grid" id="scoreGrid"></div>
  </section>

</div>

<script>
// Team color badges
const TEAM = { ARI:'#97233F', ATL:'#A71930', BAL:'#241773', BUF:'#00338D', CAR:'#0085CA', CHI:'#0B162A',
  CIN:'#FB4F14', CLE:'#311D00', DAL:'#041E42', DEN:'#FB4F14', DET:'#0076B6', GB:'#203731', HOU:'#03202F',
  IND:'#002C5F', JAX:'#006778', KC:'#E31837', LAC:'#0080C6', LAR:'#003594', LV:'#000000', MIA:'#008E97',
  MIN:'#4F2683', NE:'#002244', NO:'#D3BC8D', NYG:'#0B2265', NYJ:'#125740', PHI:'#004C54', PIT:'#FFB612',
  SF:'#AA0000', SEA:'#002244', TB:'#D50A0A', TEN:'#0C2340', WAS:'#5A1414' };
function badge(abbr){ const c = TEAM[abbr] || '#4b5563'; return `<div class="badge" style="background:${c}">${abbr}</div>`; }

// Helpers
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
async function msf(path,q=''){ const url=`/api/msf?path=${encodeURIComponent(path)}${q?`&q=${encodeURIComponent(q)}`:''}`; const r=await fetch(url); if(!r.ok) throw new Error('MSF '+r.status); return r.json(); }
function safe(obj, ...keys){ return keys.reduce((o,k)=>o && o[k]!=null ? o[k] : undefined, obj); }

// Week list -> build Sunday set + game keys
async function getSundayGames(){
  let wk;
  try{ wk = await msf('v2.0/pull/nfl/2025-regular/week/4/games.json'); }
  catch(e){ wk = await msf('v2.1/pull/nfl/2025-regular/week/4/games.json'); }
  const items = (wk.games||wk.game||[]).filter(g=> (safe(g,'schedule','startTime')||'').slice(0,10)==='2025-09-28');
  return items.map(g=>{
    const sch=g.schedule||{}; const away=g.awayTeam||g.away||{}; const home=g.homeTeam||g.home||{};
    const id=sch.id; const date=(sch.startTime||'').slice(0,10).replaceAll('-','');
    const awayAb=away.abbreviation||away.abbr||away.code; const homeAb=home.abbreviation||home.abbr||home.code;
    const key = `${date}-${awayAb}-${homeAb}`;
    return { id, key, awayAb, homeAb, awayName:`${away.city?away.city+' ':''}${away.name||awayAb}`, homeName:`${home.city?home.city+' ':''}${home.name||homeAb}` };
  });
}

// Scores using team gamelogs
function gameCard(g){
  return `<div class="card" data-id="${g.id}">
    <div class="row">
      <div class="row" style="gap:8px"><div>${badge(g.awayAb)}</div><div><div class="label">${g.awayName}</div><div class="score" data-away>0</div></div></div>
      <div class="row" style="gap:8px"><div>${badge(g.homeAb)}</div><div><div class="label">${g.homeName}</div><div class="score" data-home>0</div></div></div>
    </div>
    <div class="label" data-status>‚Äî</div>
  </div>`;
}
async function refreshScores(games){
  await Promise.all(games.map(async g=>{
    try{
      const date = g.key.slice(0,8);
      const feed = await msf(`v2.1/pull/nfl/2025-regular/date/${date}/team_gamelogs.json`, 'game='+g.key);
      const logs = feed?.teamGamelogs || feed?.gamelogs || [];
      const card = qs(`.card[data-id="${g.id}"]`); if(!card) return;
      logs.forEach(l=>{
        const ab = l?.team?.abbreviation;
        const pts = Number(l?.stats?.miscellaneous?.points || l?.stats?.scoring?.points || 0);
        if(ab===g.awayAb) card.querySelector('[data-away]').textContent = pts;
        if(ab===g.homeAb) card.querySelector('[data-home]').textContent = pts;
      });
      card.querySelector('[data-status]').textContent = logs.length ? 'Live/Final' : 'Scheduled';
    }catch(e){ /* leave zeros */ }
  }));
}

// ---- Bet legs via player_gamelogs ----
const GAME_KEY = { KC:null, GB:null }; // filled from week list
const LEGS = {
  'dak175':   { game:'GB', player:'dak-prescott',      target:175, group:'passing', key:'passYards' },
  'love200':  { game:'GB', player:'jordan-love',       target:200, group:'passing', key:'passYards' },
  'ferg5':    { game:'GB', player:'jake-ferguson',     target:5,   group:'receiving', key:'receptions' },
  'dak1td':   { game:'GB', player:'dak-prescott',      target:1,   group:'passing', key:'passTD' },
  'love1p5td':{ game:'GB', player:'jordan-love',       target:2,   group:'passing', key:'passTD' },
  'zay50':       { game:'KC', player:'zay-flowers',    target:50,  group:'receiving', key:'recYards' },
  'zay5rec':     { game:'KC', player:'zay-flowers',    target:5,   group:'receiving', key:'receptions' },
  'henry60':     { game:'KC', player:'derrick-henry',  target:60,  group:'rushing',   key:'rushYards' },
  'lamar30rush': { game:'KC', player:'lamar-jackson',  target:30,  group:'rushing',   key:'rushYards' },
  'lamar175pass':{ game:'KC', player:'lamar-jackson',  target:175, group:'passing',   key:'passYards' },
  'mah200':      { game:'KC', player:'patrick-mahomes',target:200, group:'passing',   key:'passYards' },
  'lamar175pass_d':{ game:'KC', player:'lamar-jackson',target:175, group:'passing',   key:'passYards' },
  'zay30':       { game:'KC', player:'zay-flowers',    target:30,  group:'receiving', key:'recYards' },
  'kelce20':     { game:'KC', player:'travis-kelce',   target:20,  group:'receiving', key:'recYards' },
  'mah1td':      { game:'KC', player:'patrick-mahomes',target:1,   group:'passing',   key:'passTD' },
  'lamar1td':    { game:'KC', player:'lamar-jackson',  target:1,   group:'passing',   key:'passTD' },
};
const SLIPS = {
  'slip-gb-a':    ['dak175','love200','ferg5','dak1td','love1p5td'],
  'slip-kc-c':    ['zay50','zay5rec','henry60','lamar30rush','lamar175pass'],
  'slip-kc-d':    ['mah200','lamar175pass_d','zay30','kelce20','mah1td','lamar1td'],
};
function setValForLeg(legId, value){
  const leg = qs(`.leg[data-leg-id="${legId}"]`); if(!leg) return;
  const valEl=leg.querySelector('.val'); const fill=leg.querySelector('.fill'); const pct=leg.querySelector('.pct');
  const target = Number(valEl.dataset.target); const now = Number(value||0);
  valEl.textContent = String(now);
  const p = Math.max(0, Math.min(100, Math.round((now/target)*100)));
  fill.style.width = p+'%'; fill.style.background = (now>=target)?'linear-gradient(90deg,#10b981,#38bdf8)':'linear-gradient(90deg,#ef4444,#f59e0b)';
  pct.textContent = p+'%';
}
function renderSlips(){
  Object.keys(SLIPS).forEach(id=>{
    const legs=SLIPS[id]; let hit=0;
    legs.forEach(l=>{ const v=Number(qs(`.leg[data-leg-id="${l}"] .val`).textContent||0); if(v>=LEGS[l].target) hit++; });
    const fill=qs(`#${id}-fill`); if(fill) fill.style.width = Math.round(100*hit/legs.length)+'%';
    const tag=qs(`#${id}-count`); if(tag) tag.textContent=`${hit} / ${legs.length}`;
  });
}
function valFromStats(stats, group, key){
  const g = stats?.[group] || {};
  const map = {
    passYards:['passYards','passingYards','passGrossYards','passNetYards','yards'],
    passTD:['passTD','passTDs','passingTD','td'],
    recYards:['recYards','receivingYards','yards'],
    receptions:['receptions','catches','rec'],
    rushYards:['rushYards','rushingYards','yards'],
  };
  const keys = map[key] || [key];
  for(const k of keys){ if(g[k]!=null) return Number(g[k])||0; }
  return 0;
}
async function refreshBets(){
  // Build query by game (KC/GB) and needed players
  const neededKC = Object.values(LEGS).filter(x=>x.game==='KC').map(x=>x.player);
  const neededGB = Object.values(LEGS).filter(x=>x.game==='GB').map(x=>x.player);
  const uniq = arr => Array.from(new Set(arr));
  const dateKC = GAME_KEY.KC?.slice(0,8); const dateGB = GAME_KEY.GB?.slice(0,8);
  try{
    if(GAME_KEY.KC){
      const kc = await msf(`v2.1/pull/nfl/2025-regular/date/${dateKC}/player_gamelogs.json`, 'game='+GAME_KEY.KC+'&player='+uniq(neededKC).join(','));
      const logs = kc?.playerGamelogs || kc?.gamelogs || [];
      logs.forEach(l=>{
        const slug = (l?.player?.firstName+'-'+l?.player?.lastName).toLowerCase().replace(/[^a-z\-]/g,'');
        // Find matching legs
        Object.entries(LEGS).forEach(([id,cfg])=>{
          if(cfg.game==='KC' && cfg.player===slug){
            setValForLeg(id, valFromStats(l.stats, cfg.group, cfg.key));
          }
        });
      });
    }
    if(GAME_KEY.GB){
      const gb = await msf(`v2.1/pull/nfl/2025-regular/date/${dateGB}/player_gamelogs.json`, 'game='+GAME_KEY.GB+'&player='+uniq(neededGB).join(','));
      const logs = gb?.playerGamelogs || gb?.gamelogs || [];
      logs.forEach(l=>{
        const slug = (l?.player?.firstName+'-'+l?.player?.lastName).toLowerCase().replace(/[^a-z\-]/g,'');
        Object.entries(LEGS).forEach(([id,cfg])=>{
          if(cfg.game==='GB' && cfg.player===slug){
            setValForLeg(id, valFromStats(l.stats, cfg.group, cfg.key));
          }
        });
      });
    }
    renderSlips();
  }catch(e){ /* no-op until kickoff */ }
}

// Tabs
qsa('.tab').forEach(t=>t.onclick=()=>{
  qsa('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const tab = t.dataset.tab; document.querySelector('#tab-scores').classList.toggle('hide', tab!=='scores');
});

(async function init(){
  const sunday = await getSundayGames();
  // Find our two games and fill GAME_KEYs
  sunday.forEach(g=>{
    if(g.awayAb==='KC' && g.homeAb==='BAL' || g.awayAb==='BAL' && g.homeAb==='KC') GAME_KEY.KC = g.key;
    if(g.awayAb==='GB' && g.homeAb==='DAL' || g.awayAb==='DAL' && g.homeAb==='GB') GAME_KEY.GB = g.key;
  });
  // Build scores grid
  qs('#scoreGrid').innerHTML = sunday.map(gameCard).join('');
  const tick = async ()=>{ await refreshBets(); await refreshScores(sunday); };
  tick(); setInterval(tick, 20000);
})();
</script>
</body>
</html>
